var {
  path
} = require("../nodeDeps.js");


var semver = require("semver");

module.exports = function (Registry) {

  var Package = Registry.Package;

  function RegistryClass() {
    this.name = "node_modules";
    this.constructor.call(this);
    this.setDefault();
  }

  RegistryClass.prototype = Registry.create();


  RegistryClass.prototype.packageExist = async function (basePath, packageName, packageVersion) {
    var context = this.context;
    basePath = basePath || this.context.basePath;

    var packageJSON;
    if(packageName){
      var possiblePaths = this.buildPossiblePaths(basePath);
      for (var i in possiblePaths) {
        var packageLocation = possiblePaths[i] + packageName + "/";
        packageJSON = await context._fetch(packageLocation + "package.json");
        try {
          packageJSON = JSON.parse(packageJSON);
        } catch (e) {
          packageJSON = false;
        }
        if (!packageJSON) 
          continue;
        else {
          if(!packageJSON.name == packageName) continue;
          if (packageVersion && !semver.satisfies(packageJSON.version, packageVersion)) continue;
          return packageLocation;
        }
      }
    }else{
      packageJSON = await context._fetch(basePath + "package.json");
      try {
        packageJSON = JSON.parse(packageJSON);
      } catch (e) {
        packageJSON = false;
      }
      if(packageJSON)  
          return basePath;
    }
    return false;

  };

  RegistryClass.prototype.getPackage = async function (basePath, packageName, packageVersion) {
    var registry = this;
    var context = this.context;

    basePath = basePath || this.context.basePath;

    var packagePath = await this.packageExist(basePath, packageName, packageVersion);
    
    if(!packagePath) return false;
    
    if (Registry.__PACKAGES[packagePath])
      return Registry.__PACKAGES[packagePath];

      Registry.__PACKAGES[packagePath] = new PackageClass(registry, packagePath, "path");

    return Registry.__PACKAGES[packagePath];

  };

  RegistryClass.prototype.buildPossiblePaths = function __buildPossiblePaths(basePath) {
    var context = this.context;
    basePath = basePath || this.context.basePath;

    basePath = context._urlify(basePath);
    var bp = basePath.href; //basePath
    var $paths = [];
    $paths.push(bp); //add basePath
    $paths.push(basePath.href + "node_modules/"); // bp+ ./node_modules/
    while (((basePath.pathname = "../") && basePath.pathname !== "/")) { //step down a folder
      $paths.push(basePath.href + "node_modules/"); //bp+ ./node_modules/
    }
    $paths.push(basePath.href + "node_modules/"); //add root /node_modules/

    return $paths;
  };


  function PackageClass(...args) {
    this.constructor.apply(this, args);
  }

  PackageClass.prototype = Package.create();



  Registry.define(new RegistryClass());
};
